<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Notes Arena - AI Edition</title>
<link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
<script type="importmap">
  {
    "imports": {
      "firebase/app": "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js",
      "firebase/firestore": "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js",
      "firebase/auth": "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js"
    }
  }
</script>
<style id="themeStyle">
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
}

:root {
  --primary: #2ecc71; 
  --bg-overlay: rgba(10, 26, 10, 0.85);
  --card-bg: rgba(0, 0, 0, 0.65);
  --modal-bg: #0a1a0a;
  --text: #2ecc71;
}

body {
  font-family: 'Georgia', serif;
  background: url("https://images.unsplash.com/photo-1441974231531-c6227db76b6e?auto=format&fit=crop&q=80&w=1000");
  background-attachment: fixed;
  background-size: cover;
  background-position: center;
  color: var(--text);
  min-height: 100vh;
  transition: all 0.5s ease;
  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
  user-select: text; 
}

.header {
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(15px);
  border-bottom: 2px solid var(--primary);
  padding: 25px;
  text-align: center;
  position: sticky;
  top: 0;
  z-index: 500;
}

.header h1 {
  font-size: clamp(24px, 8vw, 42px);
  font-weight: 900;
  letter-spacing: 10px;
  text-transform: uppercase;
  color: var(--primary);
  text-shadow: 0 0 15px var(--primary), 2px 2px 5px #000;
}

.container {
  padding: 20px;
  max-width: 1000px;
  margin: 0 auto;
}

.search-container {
  display: flex;
  gap: 10px;
  margin: 20px 0;
  position: sticky;
  top: 105px;
  z-index: 400;
}

.search-box {
  background: rgba(0, 0, 0, 0.8);
  border: 2px solid var(--primary);
  color: #fff;
  padding: 12px 20px;
  border-radius: 50px;
  flex: 1;
  outline: none;
  box-shadow: 0 0 20px rgba(46, 204, 113, 0.2);
  font-family: inherit;
}

.controls {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 8px;
  margin-bottom: 30px;
}

.btn {
  background: rgba(46, 204, 113, 0.1);
  border: 1px solid var(--primary);
  color: var(--primary);
  padding: 10px 5px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
  text-transform: uppercase;
  font-size: 10px;
  transition: 0.3s;
  backdrop-filter: blur(5px);
  font-family: inherit;
  text-shadow: 1px 1px 2px #000;
  text-align: center;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.btn:hover {
  background: var(--primary);
  color: #000;
  box-shadow: 0 0 20px var(--primary);
  text-shadow: none;
}

.notes-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 20px;
  margin-bottom: 40px;
}

.note-card {
  background: var(--card-bg);
  border: 1px solid rgba(46, 204, 113, 0.3);
  padding: 35px 20px; 
  border-radius: 15px;
  cursor: pointer;
  transition: 0.4s;
  backdrop-filter: blur(12px);
  position: relative;
  overflow: hidden;
  user-select: none;
}

.note-card:hover {
  transform: translateY(-8px);
  border-color: var(--primary);
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
}

.card-actions {
  display: none;
  position: absolute;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.9);
  flex-direction: column;
  justify-content: center;
  align-items: center;
  gap: 12px;
  z-index: 100;
}

.note-title { font-size: 20px; font-weight: bold; margin-bottom: 12px; color: #fff; text-shadow: 2px 2px 4px #000; }
.note-date { font-size: 11px; color: var(--primary); opacity: 0.9; margin-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px; }

.modal {
  display: none;
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.92);
  z-index: 2000;
  backdrop-filter: blur(10px);
}

.centered-modal-content {
  background: var(--modal-bg);
  border: 2px solid var(--primary);
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 90%;
  max-width: 450px;
  border-radius: 20px;
  overflow: hidden;
  box-shadow: 0 0 30px rgba(0,0,0,0.5);
}

.modal-content {
  background: var(--modal-bg);
  border: 2px solid var(--primary);
  margin: 2% auto;
  width: 95%;
  max-width: 600px;
  border-radius: 20px;
  max-height: 97vh;
  overflow: hidden;
  position: relative;
  display: flex;
  flex-direction: column;
}

.modal-sticky-header {
  background: rgba(0, 0, 0, 0.6);
  padding: 15px;
  border-bottom: 1px solid var(--primary);
  position: sticky;
  top: 0;
  z-index: 2100;
  text-align: center;
  backdrop-filter: blur(10px);
}

.modal-body {
  padding: 25px;
  overflow-y: auto;
  flex: 1;
  background: rgba(0,0,0,0.2);
}

.close { 
  color: var(--primary); 
  font-size: 30px; 
  cursor: pointer; 
  position: absolute; 
  right: 20px; 
  top: 15px; 
}

.rtl-detect { 
  direction: rtl !important; 
  text-align: right !important; 
  font-family: 'Amiri', serif !important; 
  line-height: 1.6;
}
.ltr-detect { 
  direction: ltr !important; 
  text-align: left !important; 
}

[contenteditable="true"]:focus {
    outline: 1px dashed var(--primary);
    background: rgba(255,255,255,0.05);
    padding: 5px;
    border-radius: 5px;
}

.highlight { background: #ff00ff; color: #fff; padding: 1px 3px; border-radius: 3px; font-weight: bold; }
.current-highlight { background: #ffff00 !important; color: #000 !important; box-shadow: 0 0 15px #ffff00; outline: 2px solid #000; }

.stats { display: flex; gap: 15px; margin-bottom: 25px; }
.stat-card { flex: 1; background: rgba(0,0,0,0.6); padding: 15px; border-radius: 12px; text-align: center; border: 1px solid rgba(46,204,113,0.2); backdrop-filter: blur(10px); }
.stat-value { font-size: 24px; font-weight: 900; }

.section-header {
  background: rgba(0,0,0,0.4);
  padding: 12px 15px;
  border-left: 5px solid var(--primary);
  margin: 25px 0 15px 0;
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  font-weight: bold;
  backdrop-filter: blur(5px);
  text-transform: uppercase;
  letter-spacing: 2px;
}

textarea, input[type="text"], input[type="password"], select {
    width: 100%;
    background: rgba(0,0,0,0.5);
    border: 1px solid var(--primary);
    color: #fff;
    padding: 12px;
    border-radius: 8px;
    margin: 10px 0;
    font-family: inherit;
}

.welcome-title { font-size: 28px; margin-bottom: 15px; color: var(--primary); text-align: center; font-weight: 900; }
.welcome-text { color: #fff; line-height: 1.6; margin-bottom: 10px; font-family: 'Amiri', serif; font-size: 18px; }

.view-search-wrapper {
  background: rgba(10, 26, 10, 0.95);
  padding: 12px;
  border-radius: 0 0 15px 15px;
  margin-bottom: 20px;
  border: 1px solid rgba(46,204,113,0.3);
  position: sticky;
  top: 0;
  z-index: 2050;
  backdrop-filter: blur(10px);
}
.view-search-controls {
  display: flex;
  align-items: center;
  gap: 8px;
}
.search-count-tag {
  font-size: 12px;
  color: var(--primary);
  font-weight: bold;
  min-width: 60px;
}

.live-counter {
    font-size: 12px;
    color: var(--primary);
    text-align: right;
    margin-bottom: 5px;
    font-weight: bold;
}

#calcBtn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: linear-gradient(135deg, #f1c40f, #e67e22);
  border: none;
  color: white;
  font-size: 24px;
  cursor: pointer;
  z-index: 3000;
  box-shadow: 0 5px 15px rgba(0,0,0,0.3);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: 0.3s;
}

.calc-modal {
  display: none;
  position: fixed;
  bottom: 80px;
  right: 20px;
  width: 260px;
  background: #1a1a1a;
  border: 2px solid var(--primary);
  border-radius: 15px;
  padding: 15px;
  z-index: 3001;
  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
  backdrop-filter: blur(10px);
}

.calc-display {
  width: 100%;
  background: #000;
  color: var(--primary);
  border: 1px solid #333;
  padding: 10px;
  text-align: right;
  font-size: 20px;
  margin-bottom: 10px;
  border-radius: 5px;
  min-height: 45px;
}

.calc-buttons { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
.calc-btn { padding: 10px; background: #333; border: none; color: #fff; border-radius: 5px; cursor: pointer; font-weight: bold; }
.calc-btn.op { background: var(--primary); color: #000; }
.calc-btn.eq { background: #f1c40f; color: #000; grid-column: span 2; }
.calc-btn.clr { background: #e74c3c; }

.nav-controls {
  position: fixed;
  bottom: 20px;
  left: 20px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  z-index: 3000;
}

.nav-btn {
  width: 45px;
  height: 45px;
  border-radius: 12px;
  background: rgba(0, 0, 0, 0.7);
  border: 1px solid var(--primary);
  color: var(--primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
  font-weight: bold;
  backdrop-filter: blur(10px);
  transition: 0.3s;
  flex-direction: column;
}

.ai-model-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: rgba(255,255,255,0.05);
  padding: 10px;
  margin: 5px 0;
  border-radius: 5px;
}

.ai-loading {
  display: none;
  text-align: center;
  padding: 10px;
  font-style: italic;
  color: var(--primary);
}

#aiResponse {
    line-height: 1.6;
}

@media (max-width: 600px) {
  .controls {
    grid-template-columns: repeat(4, 1fr);
  }
}

.action-buttons-container {
  margin-top: 40px;
  margin-bottom: 120px; 
  padding: 10px;
  display: flex;
  flex-wrap: wrap; 
  gap: 15px; 
  justify-content: center; 
  align-items: center;
  position: relative;
  z-index: 1; 
}

.action-buttons-container button, 
.action-buttons-container .btn {
  flex: 1 1 auto; 
  min-width: 120px; 
  max-width: 180px; 
  padding: 10px 15px;
  text-align: center;
  white-space: nowrap; 
}

.user-info {
  font-size: 10px;
  color: var(--primary);
  margin-top: 5px;
  font-weight: bold;
}

</style>
</head>
<body id="mainBody">

<div class="nav-controls">
  <button class="nav-btn" onclick="scrollToTop()"><span>‚Üë</span>START</button>
  <button class="nav-btn" onclick="scrollToEnd()"><span>‚Üì</span>END</button>
</div>

<button id="calcBtn" onclick="toggleCalc()">üßÆ</button>
<div id="calcPanel" class="calc-modal">
  <div class="calc-display" id="calcScreen">0</div>
  <div class="calc-buttons">
    <button class="calc-btn clr" onclick="clearCalc()">C</button>
    <button class="calc-btn" onclick="pressCalc('(')">(</button>
    <button class="calc-btn" onclick="pressCalc(')')">)</button>
    <button class="calc-btn op" onclick="pressCalc('/')">√∑</button>
    <button class="calc-btn" onclick="pressCalc('7')">7</button>
    <button class="calc-btn" onclick="pressCalc('8')">8</button>
    <button class="calc-btn" onclick="pressCalc('9')">9</button>
    <button class="calc-btn op" onclick="pressCalc('*')">√ó</button>
    <button class="calc-btn" onclick="pressCalc('4')">4</button>
    <button class="calc-btn" onclick="pressCalc('5')">5</button>
    <button class="calc-btn" onclick="pressCalc('6')">6</button>
    <button class="calc-btn op" onclick="pressCalc('-')">-</button>
    <button class="calc-btn" onclick="pressCalc('1')">1</button>
    <button class="calc-btn" onclick="pressCalc('2')">2</button>
    <button class="calc-btn" onclick="pressCalc('3')">3</button>
    <button class="calc-btn op" onclick="pressCalc('+')">+</button>
    <button class="calc-btn" onclick="pressCalc('0')">0</button>
    <button class="calc-btn" onclick="pressCalc('.')">.</button>
    <button class="calc-btn eq" onclick="solveCalc()">=</button>
  </div>
</div>

<div class="header">
  <h1>NOTES ARENA</h1>
  <div style="letter-spacing: 4px; font-size: 10px; color: #fff; opacity: 0.8;">DESIGNED BY| HASH TECH</div>
  <div id="authUserInfo" class="user-info">Not Logged In</div>
</div>

<div class="container">
  <div class="stats">
    <div class="stat-card">
        <div class="stat-value" id="totalCount">0</div>
        <div style="font-size: 11px; text-transform: uppercase; color:#fff;">Total Notes</div>
    </div>
    <div class="stat-card" style="border-color: #ff4444;">
        <div class="stat-value" id="trashCount" style="color: #ff4444;">0</div>
        <div style="font-size: 11px; text-transform: uppercase; color: #ff4444;">Bin</div>
    </div>
  </div>

  <div class="search-container">
    <input type="text" id="searchBox" class="search-box" placeholder="üîç Search notes...">
    <button class="btn" onclick="findNextHighlight('main')" style="max-width: 60px;">Next</button>
  </div>

  <div class="controls">
    <button class="btn" onclick="openCreateModal()" style="background: var(--primary); color: #000; text-shadow: none;">‚ûï New</button>
    <button id="loginBtn" class="btn" style="border-color:#4285F4; color:#4285F4;">üåê Login</button>
    <button class="btn" onclick="toggleSection('trashSection')">üóë Bin</button>
    <button class="btn" onclick="changeTheme()" id="themeBtn">üé® Theme</button>
    <button class="btn" onclick="changeFont()" id="fontBtn">Aa Font</button>
    <button class="btn" onclick="openAiSettings()">ü§ñ AI Set</button>
    <button class="btn" onclick="exportNotes()">üì§ Export</button>
    <button class="btn" onclick="document.getElementById('importInput').click()">üì• Import</button>
    <button class="btn" onclick="document.getElementById('exitModal').style.display = 'block'">üö™ Exit</button>
    <input type="file" id="importInput" style="display:none;" accept=".json" onchange="importNotes(event)">
  </div>

  <div class="section-header" onclick="toggleSection('notesContainer')">
      <span>üìù All Notes</span>
      <span>‚ñº</span>
  </div>
  <div id="notesContainer" class="notes-grid"></div>

  <div id="pinnedSection" style="display:none;">
      <div class="section-header" onclick="toggleSection('pinnedContainer')">
        <span>üìå Pinned Notes</span>
        <span id="pinnedIndicator">‚ñº</span>
      </div>
      <div id="pinnedContainer" class="notes-grid"></div>
  </div>

  <div id="categorySections"></div>

  <div id="trashSection" style="display:none;">
    <div class="section-header" style="border-color:#ff4444; color:#ff4444;" onclick="toggleSection('trashContainer')">
        <span>üóë TRASH BIN</span>
        <span>‚ñº</span>
    </div>
    <div id="trashContainer" class="notes-grid"></div>
  </div>
</div>

<div id="aiSettingsModal" class="modal">
  <div class="modal-content">
    <div class="modal-sticky-header">
      <h2 style="color:var(--primary);">AI SETTINGS</h2>
      <span class="close" onclick="closeModal('aiSettingsModal')">&times;</span>
    </div>
    <div class="modal-body">
      <label style="color:#fff;">OpenRouter API Key:</label>
      <input type="password" id="aiApiKey" placeholder="sk-or-v1-....">
      
      <div style="margin-top:20px;">
        <label style="color:#fff;">Add Model (ID):</label>
        <div style="display:flex; gap:5px;">
          <input type="text" id="newModelId" placeholder="e.g. google/gemini-2.0-flash-exp:free" style="flex:1;">
          <button class="btn" onclick="addAiModel()">ADD</button>
        </div>
      </div>

      <div id="aiModelsList" style="margin-top:20px;"></div>
      
      <button class="btn" onclick="saveAiSettings()" style="width:100%; margin-top:20px; background:var(--primary); color:#000;">SAVE AI CONFIG</button>
    </div>
  </div>
</div>

<div id="welcomeModal" class="modal">
  <div class="centered-modal-content">
    <div class="modal-body">
      <div class="welcome-title">WELCOME TO NOTES ARENA</div>
      <div class="welcome-text" dir="rtl">
        ÿÆŸàÿ¥ ÿ¢ŸÖÿØ€åÿØ! "Notes Arena" Ÿæÿ±€åŸÖ€åŸÖ ÿß€å⁄à€åÿ¥ŸÜ ŸÖ€å⁄∫ ÿ¢Ÿæ ÿßŸæŸÜ€å €åÿßÿØÿØÿßÿ¥ÿ™Ÿà⁄∫ ⁄©Ÿà ŸÖÿ≠ŸÅŸàÿ∏ ⁄©ÿ± ÿ≥⁄©ÿ™€í €Å€å⁄∫€î<br><br>
        ‚Ä¢ ŸÜ€åÿß ŸÜŸàŸπ ÿ®ŸÜÿßŸÜ€í ⁄©€í ŸÑ€å€í ‚ûï ÿ®ŸπŸÜ ÿØÿ®ÿßÿ¶€å⁄∫€î<br>
        ‚Ä¢ ŸÜŸàŸπ ⁄©Ÿà ÿß€å⁄àŸπ ⁄©ÿ±ŸÜ€í ⁄©€í ŸÑ€å€í ÿßÿ≥ Ÿæÿ± ⁄©ŸÑ⁄© ⁄©ÿ±€å⁄∫€î<br>
        ‚Ä¢ ÿßŸæŸÜ€å Ÿæÿ≥ŸÜÿØ ⁄©€í ÿ±ŸÜ⁄ØŸà⁄∫ ⁄©€í ŸÑ€å€í ÿ™⁄æ€åŸÖ ⁄©ÿß ÿ®ŸπŸÜ ÿØÿ®ÿßÿ¶€å⁄∫€î
      </div>
      <button class="btn" onclick="closeModal('welcomeModal')" style="width:100%; background:var(--primary); color:#000; font-size:18px; margin-top:20px;">START NOW</button>
    </div>
  </div>
</div>

<div id="exitModal" class="modal">
  <div class="centered-modal-content" style="max-width: 400px;">
    <div class="modal-body" style="text-align:center;">
      <div class="welcome-title" style="color:#ff4444;">EXIT APP?</div>
      <p style="color:#fff; margin-bottom:20px;">Are you sure you want to close the app?</p>
      <div style="display:flex; gap:10px;">
        <button class="btn" onclick="closeModal('exitModal')" style="flex:1;">CANCEL</button>
        <button class="btn" onclick="window.close(); location.reload();" style="flex:1; background:#ff4444; color:#fff; border-color:#ff4444;">EXIT</button>
      </div>
    </div>
  </div>
</div>

<div id="viewModal" class="modal">
  <div class="modal-content">
    <div class="modal-sticky-header">
      <div style="font-size: 18px; font-weight: 900; letter-spacing: 5px; color: var(--primary); text-shadow: 0 0 10px var(--primary);">NOTES ARENA</div>
      <span class="close" onclick="closeModal('viewModal')">&times;</span>
    </div>
    <div class="modal-body" id="viewModalBody" style="padding-top:0;">
      <div class="view-search-wrapper" id="viewSearchArea">
        <div class="view-search-controls">
          <input type="text" id="viewSearchBox" class="search-box" style="margin:0; padding:8px 15px;" placeholder="Search in this note..." oninput="searchTextInNote()">
          <span id="viewSearchCount" class="search-count-tag">0 / 0</span>
          <button class="btn" style="padding:8px 12px;" onclick="navigateNoteSearch(1)">Next</button>
        </div>
      </div>

      <div class="live-counter" id="viewCharCounter">Chars: 0</div>
      <h2 id="viewTitle" contenteditable="true" oninput="liveUpdateNote('title', this)" style="color:#fff; margin-bottom:15px; font-size: 24px; text-shadow: 2px 2px 4px #000; outline:none; margin-top:15px;"></h2>
      
      <div id="viewBody" contenteditable="true" oninput="liveUpdateNote('content', this)" style="line-height:1.8; color:#eee; white-space: pre-wrap; font-size: 16px; text-shadow: 1px 1px 1px #000; outline:none; min-height: 100px;"></div>
      
      <div id="aiLoading" class="ai-loading">Arena AI is thinking...</div>
      <div id="aiResponse" style="display:none; background:rgba(46,204,113,0.1); border:1px solid var(--primary); padding:15px; border-radius:10px; margin:15px 0; color:#fff; font-size:14px; white-space: pre-wrap; position: relative;">
        <div id="aiText"></div>
        <button class="btn" onclick="copyContent('aiText')" style="margin-top:10px; font-size:9px; padding:5px 10px;">üìã Copy AI Response</button>
      </div>

      <div id="viewChecklist" style="margin-top:20px; color:#fff;"></div>
      
      <div id="viewMeta" class="note-date"></div>
      <div id="viewEditMeta" style="font-size: 10px; color: #fff; opacity: 0.7; margin-top: 5px;"></div>
      
      <div class="action-buttons-container">
        <button class="btn" onclick="askArenaAI()" style="border-color:#00d9ff; color:#00d9ff;">üí¨ Ask AI</button>
        <button class="btn" onclick="saveAsTxt()" style="border-color:#f39c12; color:#f39c12;">üìÅ Save as TXT</button>
        <button class="btn" onclick="copyContent('viewBody')" style="border-color:#2ecc71; color:#2ecc71;">üìã Copy Note</button>
        <button class="btn" onclick="shareToWhatsapp()" style="border-color:#25D366; color:#25D366;">üì≤ WhatsApp</button>
        <button class="btn" id="fullEditBtn">Advanced Edit</button>
        <button class="btn" id="pinBtn">Pin</button>
        <button class="btn" id="deleteBtn" style="border-color:#ff4444; color:#ff4444;">Move to Bin</button>
      </div>
    </div>
  </div>
</div>

<div id="editModal" class="modal">
  <div class="modal-content">
    <div class="modal-sticky-header">
        <h2 id="modalActionTitle" style="color:var(--primary);">New Note</h2>
        <span class="close" onclick="closeModal('editModal')">&times;</span>
    </div>
    <div class="modal-body">
        <input type="text" id="noteTitle" placeholder="Note Title..." oninput="autoDetectRTL(this)">
        <select id="noteCategory">
          <option value="General">General</option>
          <option value="Personal">Personal</option>
          <option value="Work">Work</option>
          <option value="Ideas">Ideas</option>
          <option value="Important">Important</option>
        </select>
        <label style="display:block; margin: 15px 0; cursor:pointer; color:#fff;">
            <input type="checkbox" id="isChecklist" onchange="toggleEditorType()"> Checklist Mode
        </label>
        
        <div class="live-counter" id="editCharCounter">Chars: 0</div>
        
        <div id="textEditor"><textarea id="noteContent" rows="12" placeholder="Start typing..." oninput="autoDetectRTL(this); updateCharCount('noteContent', 'editCharCounter')"></textarea></div>
        <div id="checklistEditor" style="display:none;">
          <div id="checklistItems"></div>
          <button class="btn" onclick="addChecklistItem()" style="width:100%;">+ Add Item</button>
        </div>
        <button class="btn" onclick="saveNote()" style="width:100%; margin-top:25px; background:var(--primary); color:#000; font-size: 16px; text-shadow: none;">SAVE FINAL</button>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "firebase/app";
  import { getFirestore, doc, setDoc, collection, query, getDocs } from "firebase/firestore";
  import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "firebase/auth";

  const firebaseConfig = {
    apiKey: "AIzaSyCNwmYHsc46zIY4ZHIHW96APheyLWU82Q8",
    authDomain: "notes-arena-9eaf8.firebaseapp.com",
    projectId: "notes-arena-9eaf8",
    storageBucket: "notes-arena-9eaf8.appspot.com",
    messagingSenderId: "486213454989",
    appId: "1:486213454989:web:940b0c2d26b546192a26c4"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  let currentUser = null;

  // Login Function
  window.loginWithGoogle = async function() {
    try {
      const result = await signInWithPopup(auth, provider);
      alert("Welcome " + result.user.displayName + "!");
    } catch (error) {
      console.error("Login Error:", error);
      alert("Login Failed! Make sure your domain is added in Firebase Console.");
    }
  };

  // Logout Function
  window.logoutApp = function() {
      signOut(auth).then(() => {
          alert("Logged out successfully!");
          location.reload();
      });
  };

  // Load Data from Firebase on Login
  async function loadUserNotes(uid) {
      try {
          const q = query(collection(db, "users", uid, "notes"));
          const querySnapshot = await getDocs(q);
          const cloudNotes = [];
          querySnapshot.forEach((doc) => {
              cloudNotes.push(doc.data());
          });
          if(cloudNotes.length > 0) {
              // Merge local and cloud (Cloud wins)
              window.notes = [...cloudNotes];
              localStorage.setItem('ss_notes', JSON.stringify(window.notes));
              window.renderNotes();
          }
      } catch (e) {
          console.error("Error loading cloud notes:", e);
      }
  }

  // Auth State Listener
  onAuthStateChanged(auth, (user) => {
    const loginBtn = document.getElementById('loginBtn');
    const authStatus = document.getElementById('authUserInfo');
    if (user) {
      currentUser = user;
      loginBtn.innerText = "üö™ Logout";
      loginBtn.style.borderColor = "#ff4444";
      loginBtn.style.color = "#ff4444";
      loginBtn.onclick = window.logoutApp;
      authStatus.innerText = `Logged in as: ${user.displayName}`;
      authStatus.style.color = "#2ecc71";
      loadUserNotes(user.uid);
    } else {
      currentUser = null;
      loginBtn.innerText = "üåê Login";
      loginBtn.style.borderColor = "#4285F4";
      loginBtn.style.color = "#4285F4";
      loginBtn.onclick = window.loginWithGoogle;
      authStatus.innerText = "Not Logged In";
      authStatus.style.color = "#ff4444";
    }
  });

  // Sync Note Function
  window.syncNoteToFirebase = async function(noteData) {
    if (!currentUser) return;
    try {
      await setDoc(doc(db, "users", currentUser.uid, "notes", noteData.id.toString()), {
        ...noteData,
        syncTime: new Date().toISOString()
      });
      console.log("Synced to Cloud");
    } catch (e) {
      console.error("Firebase Sync Error:", e);
    }
  };
</script>

<script>
const DEFAULT_API_KEY = "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"; 
const PRESET_MODELS = [
    'stepfun/step-3.5-flash:free',
    'openrouter/free',
    'arcee-ai/trinity-large-preview:free',
    'openai/gpt-oss-20b:free'
];

window.notes = JSON.parse(localStorage.getItem('ss_notes')) || [];
let trash = JSON.parse(localStorage.getItem('ss_trash')) || [];
let currentThemeIdx = 2;
let currentFontIdx = 0;
let editingId = null;
let currentSearchIndex = -1;
let noteSearchIndex = -1;
let longPressTimer;

let aiConfig = JSON.parse(localStorage.getItem('arena_ai_config')) || {
  key: btoa(DEFAULT_API_KEY), 
  models: [...PRESET_MODELS],
  selectedModel: PRESET_MODELS[0]
};

document.oncontextmenu = function(e) { 
  if(e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT' || e.target.contentEditable === 'true') return true;
  return false; 
};

const themes = [
    { name: 'Neon Cyber', primary: '#00d9ff', bg: 'linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%)', modal: '#0f1535' },
    { name: 'Space Nebula', primary: '#cc00ff', bg: 'url("https://images.unsplash.com/photo-1464802686167-b939a6910659?auto=format&fit=crop&q=80&w=1000")', modal: '#1a0033' },
    { name: 'Forest Mist', primary: '#2ecc71', bg: 'url("https://images.unsplash.com/photo-1441974231531-c6227db76b6e?auto=format&fit=crop&q=80&w=1000")', modal: '#0a1a0a' },
    { name: 'Oceanic Blue', primary: '#3498db', bg: 'url("https://images.unsplash.com/photo-1505118380757-91f5f5632de0?auto=format&fit=crop&q=80&w=1000")', modal: '#001a33' },
    { name: 'Desert Gold', primary: '#f1c40f', bg: 'url("https://images.unsplash.com/photo-1473580044384-7ba9967e16a0?auto=format&fit=crop&q=80&w=1000")', modal: '#332200' },
    { name: 'Midnight City', primary: '#e74c3c', bg: 'url("https://images.unsplash.com/photo-1477346611705-65d1883cee1e?auto=format&fit=crop&q=80&w=1000")', modal: '#1a1a1a' }
];

const fonts = [
    { name: 'Classic', family: "'Georgia', serif" },
    { name: 'Modern', family: "'Segoe UI', Roboto, sans-serif" },
    { name: 'Code', family: "'Courier New', monospace" },
    { name: 'Stylish', family: "'Cursive', sans-serif" }
];

window.onload = function() {
    if (!localStorage.getItem('ss_returning_user')) {
        document.getElementById('welcomeModal').style.display = 'block';
        localStorage.setItem('ss_returning_user', 'true');
    }
    window.history.pushState({page: 1}, "", "");
    window.onpopstate = function() {
        document.getElementById('exitModal').style.display = 'block';
        window.history.pushState({page: 1}, "", "");
    };
    renderNotes();
};

function copyContent(id) {
    const el = document.getElementById(id);
    const text = el.innerText || el.value;
    navigator.clipboard.writeText(text).then(() => {
        alert("Copied to clipboard!");
    });
}

function openAiSettings() {
  document.getElementById('aiApiKey').value = aiConfig.key ? atob(aiConfig.key) : '';
  renderAiModelsList();
  document.getElementById('aiSettingsModal').style.display = 'block';
}

function renderAiModelsList() {
  const list = document.getElementById('aiModelsList');
  list.innerHTML = '<p style="color:var(--primary); font-size:12px; margin-bottom:10px;">Saved Models:</p>';
  aiConfig.models.forEach(model => {
    const isSelected = model === aiConfig.selectedModel;
    list.innerHTML += `
      <div class="ai-model-item">
        <span style="color:${isSelected ? 'var(--primary)' : '#fff'}; font-size:11px;">${model}</span>
        <div style="display:flex; gap:5px;">
          <button class="btn" style="padding:4px 8px; font-size:9px;" onclick="selectAiModel('${model}')">${isSelected ? 'ACTIVE' : 'SELECT'}</button>
          <button class="btn" style="padding:4px 8px; font-size:9px; border-color:red; color:red;" onclick="deleteAiModel('${model}')">X</button>
        </div>
      </div>
    `;
  });
}

function addAiModel() {
  const val = document.getElementById('newModelId').value.trim();
  if(val && !aiConfig.models.includes(val)) {
    aiConfig.models.push(val);
    document.getElementById('newModelId').value = '';
    renderAiModelsList();
  }
}

function deleteAiModel(m) {
  aiConfig.models = aiConfig.models.filter(x => x !== m);
  if(aiConfig.selectedModel === m) aiConfig.selectedModel = aiConfig.models[0] || '';
  renderAiModelsList();
}

function selectAiModel(m) {
  aiConfig.selectedModel = m;
  renderAiModelsList();
}

function saveAiSettings() {
  const keyRaw = document.getElementById('aiApiKey').value.trim();
  aiConfig.key = keyRaw ? btoa(keyRaw) : btoa(DEFAULT_API_KEY);
  localStorage.setItem('arena_ai_config', JSON.stringify(aiConfig));
  alert("AI Config Updated & Securely Saved!");
  closeModal('aiSettingsModal');
}

async function callArenaAI(type, customPrompt = "") {
  const note = window.notes.find(n => n.id === editingId);
  const keyToUse = aiConfig.key ? atob(aiConfig.key) : DEFAULT_API_KEY;
  if(!keyToUse) return alert("Please set a valid API Key.");
  const responseContainer = document.getElementById('aiResponse');
  const responseArea = document.getElementById('aiText');
  const loader = document.getElementById('aiLoading');
  responseContainer.style.display = 'none';
  loader.style.display = 'block';
  let prompt = `Friendly response needed. Context: ${note.content || "List"}. Query: ${customPrompt}`;
  try {
    const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
      method: "POST",
      headers: { "Authorization": `Bearer ${keyToUse}`, "Content-Type": "application/json" },
      body: JSON.stringify({ "model": aiConfig.selectedModel, "messages": [{"role": "user", "content": prompt}] })
    });
    const data = await res.json();
    loader.style.display = 'none';
    responseArea.innerText = data.choices[0].message.content;
    autoDetectRTL(responseArea); 
    responseContainer.style.display = 'block';
  } catch (err) { loader.style.display = 'none'; alert("AI Error"); }
}

function askArenaAI() {
  const q = prompt("What to ask?");
  if(q) callArenaAI('ask', q);
}

function triggerDownload(content, filename, type) {
    const blob = new Blob([content], {type: type});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; a.click();
    URL.revokeObjectURL(url);
}

function saveAsTxt() {
    const note = window.notes.find(n => n.id === editingId);
    let content = `TITLE: ${note.title}\n\n${note.isChecklist ? "Checklist" : note.content}`;
    triggerDownload(content, `${note.title}.txt`, "text/plain");
}

function autoDetectRTL(element) {
    const text = element.value || element.innerText || "";
    const urduCount = (text.match(/[\u0600-\u06FF]/g) || []).length;
    const englishCount = (text.match(/[a-zA-Z]/g) || []).length;
    if (urduCount > englishCount) { element.classList.add('rtl-detect'); element.classList.remove('ltr-detect'); }
    else { element.classList.add('ltr-detect'); element.classList.remove('rtl-detect'); }
}

function scrollToTop() {
    const vm = document.getElementById('viewModal');
    if (vm.style.display === 'block') document.getElementById('viewModalBody').scrollTo({ top: 0, behavior: 'smooth' });
    else window.scrollTo({ top: 0, behavior: 'smooth' });
}

function scrollToEnd() {
    const vm = document.getElementById('viewModal');
    if (vm.style.display === 'block') {
        const b = document.getElementById('viewModalBody');
        b.scrollTo({ top: b.scrollHeight, behavior: 'smooth' });
    } else window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
}

function updateCharCount(sourceId, targetId) {
    const s = document.getElementById(sourceId);
    if(!s) return;
    const text = (s.tagName === 'DIV') ? s.innerText : s.value;
    document.getElementById(targetId).innerText = `Chars: ${text.length}`;
}

function shareToWhatsapp() {
    const title = document.getElementById('viewTitle').innerText;
    const note = window.notes.find(n => n.id === editingId);
    let fullText = `*${title}*\n\n`;
    if(note.isChecklist) note.checklist.forEach(item => fullText += `${item.done ? '‚úÖ' : '‚ñ´Ô∏è'} ${item.text}\n`);
    else fullText += document.getElementById('viewBody').innerText;
    window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(fullText)}`, '_blank');
}

let calcExpression = "";
function toggleCalc() {
    const p = document.getElementById('calcPanel');
    p.style.display = (p.style.display === 'block') ? 'none' : 'block';
}
function pressCalc(v) { calcExpression += v; document.getElementById('calcScreen').innerText = calcExpression; }
function clearCalc() { calcExpression = ""; document.getElementById('calcScreen').innerText = "0"; }
function solveCalc() {
    try { calcExpression = eval(calcExpression).toString(); document.getElementById('calcScreen').innerText = calcExpression; }
    catch { document.getElementById('calcScreen').innerText = "Error"; calcExpression = ""; }
}

function liveUpdateNote(field, element) {
    autoDetectRTL(element);
    updateCharCount('viewBody', 'viewCharCounter');
    const note = window.notes.find(n => n.id === editingId);
    if (note) {
        if (field === 'title') note.title = element.innerText;
        if (field === 'content') note.content = element.innerText;
        note.lastEdited = new Date().toLocaleString();
        localStorage.setItem('ss_notes', JSON.stringify(window.notes));
        if(window.syncNoteToFirebase) window.syncNoteToFirebase(note);
        renderNotesGridOnly();
    }
}

function renderNotesGridOnly(searchTerm = "") {
    const main = document.getElementById('notesContainer');
    const pinned = document.getElementById('pinnedContainer');
    const catContainer = document.getElementById('categorySections');
    main.innerHTML = pinned.innerHTML = catContainer.innerHTML = "";
    const categories = {};
    const lowerSearch = searchTerm.toLowerCase();
    
    window.notes.forEach(note => {
        const matches = note.title.toLowerCase().includes(lowerSearch) || (note.content && note.content.toLowerCase().includes(lowerSearch));
        if (searchTerm && !matches) return; 
        const html = createNoteHTML(note, searchTerm);
        main.innerHTML += html;
        if(note.pinned) pinned.innerHTML += html;
        if(!categories[note.category]) categories[note.category] = "";
        categories[note.category] += html;
    });

    for (const cat in categories) {
        if (categories[cat] === "") continue;
        const catId = `cat_${cat.replace(/\s+/g, '')}`;
        catContainer.innerHTML += `<div class="section-header" onclick="toggleSection('${catId}')"><span>üìÅ ${cat}</span><span>‚ñº</span></div><div id="${catId}" class="notes-grid" style="display:none;">${categories[cat]}</div>`;
    }
}

function changeTheme() {
    currentThemeIdx = (currentThemeIdx + 1) % themes.length;
    const t = themes[currentThemeIdx];
    document.documentElement.style.setProperty('--primary', t.primary);
    if(t.bg.startsWith('url')) document.body.style.backgroundImage = t.bg;
    else { document.body.style.backgroundImage = 'none'; document.body.style.background = t.bg; }
    document.documentElement.style.setProperty('--modal-bg', t.modal);
    renderNotes();
}

function changeFont() {
    currentFontIdx = (currentFontIdx + 1) % fonts.length;
    const f = fonts[currentFontIdx];
    document.body.style.fontFamily = f.family;
    document.getElementById('fontBtn').innerText = `Aa ${f.name}`;
}

function saveToStorage() {
    localStorage.setItem('ss_notes', JSON.stringify(window.notes));
    localStorage.setItem('ss_trash', JSON.stringify(trash));
    renderNotes();
}

function toggleSection(id) {
    const el = document.getElementById(id);
    el.style.display = (el.style.display === 'none' || el.style.display === '') ? 'grid' : 'none';
}

function openCreateModal() {
    editingId = null;
    document.getElementById('modalActionTitle').innerText = "Create New Note";
    const t = document.getElementById('noteTitle');
    const c = document.getElementById('noteContent');
    t.value = ""; c.value = ""; 
    document.getElementById('noteCategory').value = "General";
    document.getElementById('isChecklist').checked = false;
    document.getElementById('checklistItems').innerHTML = "";
    updateCharCount('noteContent', 'editCharCounter');
    toggleEditorType();
    document.getElementById('editModal').style.display = 'block';
}

function toggleEditorType() {
    const isCB = document.getElementById('isChecklist').checked;
    document.getElementById('textEditor').style.display = isCB ? 'none' : 'block';
    document.getElementById('checklistEditor').style.display = isCB ? 'block' : 'none';
}

function addChecklistItem(text = "", checked = false) {
    const div = document.createElement('div');
    div.style = "display:flex; gap:10px; margin-bottom:10px;";
    div.innerHTML = `<input type="checkbox" ${checked ? 'checked' : ''}><input type="text" value="${text}" placeholder="Item..." style="margin:0; flex:1;" oninput="autoDetectRTL(this)"><button class="btn" style="padding:5px 10px; border-color:red; color:red; max-width:35px;" onclick="this.parentElement.remove()">X</button>`;
    document.getElementById('checklistItems').appendChild(div);
}

function saveNote() {
    const title = document.getElementById('noteTitle').value || "Untitled Note";
    const category = document.getElementById('noteCategory').value;
    const isChecklist = document.getElementById('isChecklist').checked;
    let content = ""; let checklist = [];
    if(isChecklist) {
        document.querySelectorAll('#checklistItems div').forEach(item => {
            const ins = item.querySelectorAll('input');
            if(ins[1]) checklist.push({ text: ins[1].value, done: ins[0].checked });
        });
    } else content = document.getElementById('noteContent').value;
    
    const now = new Date().toLocaleString();
    let finalNote = null;

    if(editingId) {
        const idx = window.notes.findIndex(n => n.id === editingId);
        if(idx > -1) {
            window.notes[idx] = { ...window.notes[idx], title, category, content, checklist, isChecklist, lastEdited: now };
            finalNote = window.notes[idx];
        }
    } else {
        const noteData = { id: Date.now(), title, category, content, checklist, isChecklist, pinned: false, timestamp: now, lastEdited: now };
        window.notes.unshift(noteData);
        finalNote = noteData;
    }

    if(finalNote && window.syncNoteToFirebase) window.syncNoteToFirebase(finalNote);
    saveToStorage();
    closeModal('editModal');
}

function viewNote(id) {
    const note = window.notes.find(n => n.id === id);
    if(!note) return;
    editingId = id;
    document.getElementById('viewTitle').innerText = note.title;
    const vBody = document.getElementById('viewBody');
    vBody.innerText = note.isChecklist ? "" : note.content;
    autoDetectRTL(document.getElementById('viewTitle'));
    autoDetectRTL(vBody);
    document.getElementById('viewMeta').innerText = `Category: ${note.category}`;
    const cb = document.getElementById('viewChecklist');
    cb.innerHTML = "";
    if(note.isChecklist) {
        vBody.style.display = "none";
        note.checklist.forEach(item => cb.innerHTML += `<div>${item.done ? '‚úÖ' : '‚¨ú'} ${item.text}</div>`);
    } else vBody.style.display = "block";
    
    document.getElementById('pinBtn').innerText = note.pinned ? "üìç Unpin" : "üìå Pin";
    document.getElementById('pinBtn').onclick = () => { note.pinned = !note.pinned; saveToStorage(); viewNote(id); };
    document.getElementById('viewModal').style.display = 'block';
}

function searchTextInNote() {
    const term = document.getElementById('viewSearchBox').value.trim();
    const vBody = document.getElementById('viewBody');
    const note = window.notes.find(n => n.id === editingId);
    if (!term) { vBody.innerText = note.content; return; }
    const reg = new RegExp(`(${term})`, "gi");
    vBody.innerHTML = note.content.replace(reg, '<span class="highlight note-result">$1</span>');
}

function navigateNoteSearch(direction) {
    const rs = document.querySelectorAll('.note-result');
    if (rs.length === 0) return;
    noteSearchIndex = (noteSearchIndex + direction) % rs.length;
    if (noteSearchIndex < 0) noteSearchIndex = rs.length - 1;
    rs[noteSearchIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function handleLongPress(id, card) {
    longPressTimer = setTimeout(() => {
        card.querySelector('.card-actions').style.display = 'flex';
    }, 600);
}
function cancelLongPress() { clearTimeout(longPressTimer); }

function findNextHighlight() {
    const els = document.querySelectorAll('.highlight');
    if(els.length === 0) return;
    currentSearchIndex = (currentSearchIndex + 1) % els.length;
    els[currentSearchIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function openEditMode(note) {
    closeModal('viewModal');
    editingId = note.id;
    document.getElementById('noteTitle').value = note.title;
    document.getElementById('noteContent').value = note.isChecklist ? "" : note.content;
    document.getElementById('editModal').style.display = 'block';
}

function closeModal(id) { document.getElementById(id).style.display = 'none'; renderNotes(); }

function createNoteHTML(note, searchTerm) {
    let title = note.title;
    return `<div class="note-card" onmousedown="handleLongPress(${note.id}, this)" onmouseup="cancelLongPress()" onclick="viewNote(${note.id})">
            <div class="card-actions" onclick="event.stopPropagation()">
                <button class="btn" onclick="openEditMode(window.notes.find(n=>n.id==${note.id}))">Edit</button>
                <button class="btn" onclick="trash.push(window.notes.find(n=>n.id==${note.id})); window.notes=window.notes.filter(n=>n.id!=${note.id}); saveToStorage();">Delete</button>
            </div>
            <div class="note-title">${title}</div>
            <div style="font-size:12px; color:var(--primary);">üìÖ ${note.timestamp}</div>
        </div>`;
}

function renderNotes(searchTerm = "") {
    renderNotesGridOnly(searchTerm);
    document.getElementById('totalCount').innerText = window.notes.length;
    document.getElementById('trashCount').innerText = trash.length;
}

function exportNotes() {
    triggerDownload(JSON.stringify(window.notes), "notes_backup.json", "application/json");
}

function importNotes(event) {
    const file = event.target.files[0];
    const reader = new FileReader();
    reader.onload = function(e) {
        window.notes = JSON.parse(e.target.result);
        saveToStorage();
    };
    reader.readAsText(file);
}

document.getElementById('searchBox').addEventListener('input', (e) => renderNotes(e.target.value));
</script>
</body>
</html>
